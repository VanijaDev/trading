// Description:
// - Two big candles of opposite directions with a small Doji in between.
// 
// ✅ Conditions:
// ✅ three candles with the first & last in opposite directions (one bullish, another bearish or vise versa).
// ✅ small tails for the first and last candles
// ✅ the first and the third candle's high & low must approximately the same
// ✅ the middle candle must be a Doji (open and close are very close)
// ✅ this pattern must be on top / bottom (last "n" candles)
// ✅ mark the pattern below if bullish / above if bearish


//@version=6
indicator("Two Big Candles with Small Between", overlay=true, shorttitle="2C Doji")

// ------------------------
// Condition 1 constant
// ------------------------
EDGE_CANDLES_SIZE_MAX_DIFF_PCT = 20.0  // Max allowed percentage difference between first and third candles' total ranges (high-low)
EDGE_TAIL_MAX_PCT = 20.0               // Each tail (upper/lower) must be <= this % of its candle total range
EDGE_HILO_MAX_DIFF_PCT = 20.0          // Allowed % difference between first & third highs/lows relative to larger edge range
DOJI_BODY_MAX = 25.0                   // Max allowed body size (absolute price units) for the middle Doji candle
FIRST_EXTREME_LOOKBACK = 10            // Pattern must sit at a top/bottom within the last N candles

// ------------------------
// Three-candle window: first = bar[2], middle = bar[1], third = current bar
// ------------------------
sizeFirst = high[2] - low[2]
sizeThird = high - low
bodyMid  = math.abs(close[1] - open[1])

bullFirst = close[2] > open[2]
bullThird = close > open

// First and third must be opposite directions
oppositeEnds = (bullFirst and (not bullThird)) or ((not bullFirst) and bullThird)

// Total range similarity within EDGE_CANDLES_SIZE_MAX_DIFF_PCT (relative to the larger range)
endsBigger = math.max(sizeFirst, sizeThird)
endsSmaller = math.min(sizeFirst, sizeThird)
endsSimilar = endsBigger > 0 ? ((endsBigger - endsSmaller) / endsBigger) * 100.0 <= EDGE_CANDLES_SIZE_MAX_DIFF_PCT : false

// Condition 1
condition1 = oppositeEnds and endsSimilar

// ------------------------
// Condition 2: Small tails for the first and last candles
// ------------------------
upperTailFirst = high[2] - math.max(open[2], close[2])
lowerTailFirst = math.min(open[2], close[2]) - low[2]
upperTailThird = high - math.max(open, close)
lowerTailThird = math.min(open, close) - low

tailLimitFirst = sizeFirst * (EDGE_TAIL_MAX_PCT / 100.0)
tailLimitThird = sizeThird * (EDGE_TAIL_MAX_PCT / 100.0)

tailsOkFirst = (sizeFirst > 0) and (upperTailFirst <= tailLimitFirst) and (lowerTailFirst <= tailLimitFirst)
tailsOkThird = (sizeThird > 0) and (upperTailThird <= tailLimitThird) and (lowerTailThird <= tailLimitThird)

condition2 = tailsOkFirst and tailsOkThird

// ------------------------
// Condition 3: First & third candle highs and lows approximately the same
// ------------------------
hiDiff = math.abs(high - high[2])
loDiff = math.abs(low - low[2])
hiLoThreshold = endsBigger * (EDGE_HILO_MAX_DIFF_PCT / 100.0)
condition3 = (hiDiff <= hiLoThreshold) and (loDiff <= hiLoThreshold)

// ------------------------
// Condition 4: Middle candle must be a Doji (tiny body)
// ------------------------
condition4 = bodyMid <= DOJI_BODY_MAX

// ------------------------
// Condition 5: Pattern must be at a top/bottom within the last N candles
// ------------------------
highestHighN = ta.highest(high[2], FIRST_EXTREME_LOOKBACK)
lowestLowN = ta.lowest(low[2], FIRST_EXTREME_LOOKBACK)

// Because condition3 already enforces similar edge highs/lows, check either edge touches the extreme
atTop = (high >= highestHighN) or (high[2] >= highestHighN)
atBottom = (low <= lowestLowN) or (low[2] <= lowestLowN)
condition5 = atTop or atBottom

// Mark pattern: below if bullish (bullThird), above if bearish
plotshape(condition1 and condition2 and condition3 and condition4 and condition5 and bullThird, title="Cond12345 Bull", location=location.belowbar, style=shape.arrowup, color=color.new(color.green, 0), size=size.tiny, text="Doji on extreme")
plotshape(condition1 and condition2 and condition3 and condition4 and condition5 and (not bullThird), title="Cond12345 Bear", location=location.abovebar, style=shape.arrowdown, color=color.new(color.red, 0), size=size.tiny, text="Doji on extreme")

