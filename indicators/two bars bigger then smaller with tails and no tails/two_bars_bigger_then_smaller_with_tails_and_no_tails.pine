// Description:
// - two bars bigger then smaller with tails and no tails (reverse pattern)
// ✅ 
// ✅ Conditions:
// ✅ 2 candles: bigger then smaller, second must be within the first size (lower high and higher low)
// ✅ candles must be of opposite directions (one bullish, another bearish or vise versa)
// ✅ both candles must have tails on one side and no tails on the other side
// ✅ this pattern must be on top / bottom (last "n" candles)
// ✅ mark the pattern below if bullish / above if bearish


//@version=6
indicator(title="2C Bigger Then Smaller (Inside)", shorttitle="2C B>S Inside", overlay=true)

// Two-candle pattern:
// - Opposite directions
// - First candle (prev) range bigger than second (current)
// - Current candle fully inside previous (lower high AND higher low)
// - Both candles must have tails on one side and no tails on the other (no-tail side can be <= threshold)

// --- Constants
const float NO_TAIL_MAX = 30.0  // max allowed tail (price units) on the "no tail" side; increase if you want to allow tiny wicks
const int   TOP_BOTTOM_LOOKBACK = 20  // pattern must occur at top/bottom of the last N candles

// --- Helpers
isBullPrev = close[1] > open[1]
isBullCur  = close > open

// Exclude dojis for direction checks
hasDirPrev = close[1] != open[1]
hasDirCur  = close != open

// Opposite directions using only bullish flags (XOR) while ensuring both bars have direction
oppositeDir = hasDirPrev and hasDirCur and (isBullPrev != isBullCur)

// Inside bar: current has lower high and higher low relative to previous
curInsidePrev = (high < high[1]) and (low > low[1])

// --- Tail logic
prevUpperTail = high[1] - math.max(open[1], close[1])
prevLowerTail = math.min(open[1], close[1]) - low[1]
curUpperTail  = high - math.max(open, close)
curLowerTail  = math.min(open, close) - low

// Same-side tails: both candles show a tail on the same side, and the opposite side has no/<= threshold
bothUpperSide = (prevUpperTail > NO_TAIL_MAX) and (curUpperTail > NO_TAIL_MAX) and (prevLowerTail <= NO_TAIL_MAX) and (curLowerTail <= NO_TAIL_MAX)
bothLowerSide = (prevLowerTail > NO_TAIL_MAX) and (curLowerTail > NO_TAIL_MAX) and (prevUpperTail <= NO_TAIL_MAX) and (curUpperTail <= NO_TAIL_MAX)
tailsCondition = bothUpperSide or bothLowerSide

corePattern = oppositeDir and curInsidePrev and tailsCondition

// --- Top/Bottom gating (first candle must be the extreme in last N)
highestHighPrevN = ta.highest(high, TOP_BOTTOM_LOOKBACK)[1]
lowestLowPrevN   = ta.lowest(low, TOP_BOTTOM_LOOKBACK)[1]
atTopPrev    = high[1] >= highestHighPrevN
atBottomPrev = low[1]  <= lowestLowPrevN

pattern = corePattern and (atTopPrev or atBottomPrev)

// --- Plot: below if bullish current, above if bearish current
plotshape(pattern and isBullCur, title="2C B>S Inside (Bull)", style=shape.arrowup,   location=location.belowbar, color=color.new(color.teal, 0),   size=size.small, text="2C")
plotshape(pattern and not isBullCur, title="2C B>S Inside (Bear)", style=shape.arrowdown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="2C")

// --- Alert
alertcondition(pattern, title="2C Bigger>Smaller Inside (Opposite)", message="Two-candle pattern: prev bigger, cur smaller inside, opposite directions.")