// Description:
// - 2 big bars with Doji or Pin between them
// ✅ 
//  Conditions:
// ✅ 3 candles with Doji or Pin bar in the middle
// ✅ edge candles must be big and of opposite directions (one bullish, another bearish or vise versa).
// ✅ edge candles must have small tails
// ✅ the first and the third candle's high & low must approximately the same
// ✅ Mark the pattern below if bullish / above if bearish


//@version=6
indicator(title="Doji/Pin Middle with Clean Sides", shorttitle="DojiMid + CleanSides", overlay=true)

// We ignore the current (forming) candle and evaluate the last closed bar only.

// --- Constants
const float MID_BODY_MAX_PCT       = 15.0  // Body <= this % of the bar's full range (high-low) for middle Doji
const float SIDE_TAIL_MAX_PCT      = 20.0  // Each tail (upper & lower) on side bars must be <= this % of that bar's range
const float SIDE_SIZE_MAX_DIFF_PCT = 15.0  // Max allowed % difference between LEFT and RIGHT bar ranges

// --- Middle bar metrics (bar[2])
midOpen = open[2]
midClose = close[2]
midHigh = high[2]
midLow = low[2]

midRange = midHigh - midLow
midBody  = math.abs(midClose - midOpen)
midBodyPct = midRange > 0 ? (midBody / midRange) * 100.0 : 0.0

isDojiPrev = (midRange > 0) and (midBodyPct <= MID_BODY_MAX_PCT)

// --- Side bars: left = bar[3], right = bar[1]
leftOpen  = open[3]
leftClose = close[3]
leftHigh  = high[3]
leftLow   = low[3]

rightOpen  = open[1]
rightClose = close[1]
rightHigh  = high[1]
rightLow   = low[1]

// Direction: sides must be opposite (exclude dojis)
isBullLeft  = leftClose > leftOpen
isBullRight = rightClose > rightOpen
hasDirLeft  = leftClose != leftOpen
hasDirRight = rightClose != rightOpen
oppositeSides = hasDirLeft and hasDirRight and (isBullLeft != isBullRight)

// Tail percentages for sides
leftRange = leftHigh - leftLow
leftUpper = leftHigh - math.max(leftOpen, leftClose)
leftLower = math.min(leftOpen, leftClose) - leftLow
leftUpperPct = leftRange > 0 ? (leftUpper / leftRange) * 100.0 : 100.0
leftLowerPct = leftRange > 0 ? (leftLower / leftRange) * 100.0 : 100.0
leftCleanTails = (leftUpperPct <= SIDE_TAIL_MAX_PCT) and (leftLowerPct <= SIDE_TAIL_MAX_PCT)

rightRange = rightHigh - rightLow
rightUpper = rightHigh - math.max(rightOpen, rightClose)
rightLower = math.min(rightOpen, rightClose) - rightLow
rightUpperPct = rightRange > 0 ? (rightUpper / rightRange) * 100.0 : 100.0
rightLowerPct = rightRange > 0 ? (rightLower / rightRange) * 100.0 : 100.0
rightCleanTails = (rightUpperPct <= SIDE_TAIL_MAX_PCT) and (rightLowerPct <= SIDE_TAIL_MAX_PCT)

cleanOppositeSides = oppositeSides and leftCleanTails and rightCleanTails

// Side-size similarity (range-based)
rangeDenom   = math.max(leftRange, rightRange)
sizeDiffPct  = rangeDenom > 0 ? (math.abs(leftRange - rightRange) / rangeDenom) * 100.0 : 0.0
similarSideSizes = rangeDenom > 0 and (sizeDiffPct <= SIDE_SIZE_MAX_DIFF_PCT)

pattern = isDojiPrev and cleanOppositeSides and similarSideSizes

// --- Plot: below if bullish right bar, above if bearish right bar (marker on bar[1])
plotshape(pattern and isBullRight, title="Doji Mid + Clean Sides (Bull)", style=shape.arrowup, location=location.belowbar, color=color.new(color.teal, 0), size=size.small, text="Doji Mid", offset=-1)
plotshape(pattern and not isBullRight, title="Doji Mid + Clean Sides (Bear)", style=shape.arrowdown, location=location.abovebar, color=color.new(color.orange, 0), size=size.small, text="Doji Mid", offset=-1)